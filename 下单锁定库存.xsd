<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="www.liuchengtu.com" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36" background="rgb(255, 255, 255)" version="24.7.8">
  <diagram name="第 1 页" id="NqzhyW3V0VyfD4l3WR-d">
    <mxGraphModel dx="2474" dy="1657" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="1" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2" value="" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=#000;verticalAlign=top;aspect=fixed;imageAspect=0;image=https://oss-liuchengtu.hudunsoft.com/userimg/d6/d6c751ebf499440c4a4538764e3e00c1.png;" parent="1" vertex="1">
          <mxGeometry x="-1466" y="980" width="1466.23" height="3473" as="geometry" />
        </mxCell>
        <mxCell id="20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="3" target="7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="3" value="调用锁定库存接口" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1610" y="-654" width="140" height="70" as="geometry" />
        </mxCell>
        <mxCell id="7" value="判断是否今日上架品" style="swimlane;" parent="1" vertex="1">
          <mxGeometry x="1180" y="-510" width="1000" height="600" as="geometry" />
        </mxCell>
        <mxCell id="22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;" parent="7" source="4" target="10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4" value="获取到缓存中所有今日上架的商品信息" style="rounded=0;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="430" y="50" width="143.5" height="80" as="geometry" />
        </mxCell>
        <mxCell id="18" value="是" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;" parent="7" source="10" target="11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="10" value="传入参数的商品id是否在库存中存在" style="rhombus;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="431.75" y="180" width="140" height="90" as="geometry" />
        </mxCell>
        <mxCell id="15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;" parent="7" source="11" target="14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="16" value="是" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;" parent="7" source="11" target="12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="11" value="判断商品id是否是今日上架&lt;span style=&quot;background-color: initial;&quot;&gt;品&lt;/span&gt;" style="rhombus;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="430" y="330" width="140" height="90" as="geometry" />
        </mxCell>
        <mxCell id="12" value="将今日上架规则赋值到产品规则中，并将真实商品id赋值到库存操作商品列表中" style="rounded=0;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="289.19" y="480" width="421.62" height="50" as="geometry" />
        </mxCell>
        <mxCell id="14" value="将非今日上架规则赋值到产品规则中" style="rounded=0;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="658" y="345" width="232" height="60" as="geometry" />
        </mxCell>
        <mxCell id="19" value="&lt;div class=&quot;lake-content&quot;&gt;&lt;p style=&quot;margin: 0; padding: 0; min-height: 24px&quot; class=&quot;ne-p&quot; id=&quot;u0f0d895e&quot;&gt;&lt;span class=&quot;ne-text&quot;&gt;&quot;今日上架&quot;规则：生产日期 &amp;gt; (配送日期 - 2)&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0; padding: 0; min-height: 24px&quot; class=&quot;ne-p&quot; id=&quot;u059ed200&quot;&gt;&lt;span class=&quot;ne-text&quot;&gt;非&quot;今日上架&quot;规则：* 生产日期 &amp;lt; (配送日期 - 1)&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7" vertex="1">
          <mxGeometry x="50" y="287.5" width="263" height="95" as="geometry" />
        </mxCell>
        <mxCell id="28" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;" parent="1" source="23" target="27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;" parent="1" source="23" target="26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="23" value="&lt;div&gt;商品参数过大，需要小于100；&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;防止降级DB时&lt;span style=&quot;background-color: initial;&quot;&gt;商品参数过大，需要小于100。&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="1548.38" y="190" width="263.25" height="50" as="geometry" />
        </mxCell>
        <mxCell id="25" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="12" target="23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;" parent="1" source="26" target="30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="26" value="&lt;div&gt;监控打点：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 订单type&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 订单来源&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 锁定顺序&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="1604.99" y="340" width="148.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="27" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;抛异常&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="1" vertex="1">
          <mxGeometry x="2650" y="940" width="120" height="70" as="geometry" />
        </mxCell>
        <mxCell id="31" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="30" target="27" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2350" y="230" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2550" y="505" />
              <mxPoint x="2550" y="975" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="32" value="加锁失败：并发下单请稍后重试" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;" parent="31" vertex="1" connectable="0">
          <mxGeometry x="-0.3106" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="1" source="30" target="35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="30" value="&lt;font style=&quot;font-size: 15px;&quot;&gt;对订单id加锁&lt;/font&gt;&lt;div style=&quot;font-size: 15px;&quot;&gt;&lt;font style=&quot;font-size: 15px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 15px;&quot;&gt;&lt;font style=&quot;font-size: 15px;&quot;&gt;店铺ID和库存操作商品id批量锁定：inventory.lock.product.%s.%s&lt;/font&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="1" vertex="1">
          <mxGeometry x="1514.72" y="470" width="330.54" height="80" as="geometry" />
        </mxCell>
        <mxCell id="42" value="已存在" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=16;" parent="1" source="35" target="38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="1" source="35" target="48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="35" value="查询订单，对订单号/ID做幂等判断" style="rhombus;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="1" vertex="1">
          <mxGeometry x="1605.87" y="595" width="148.25" height="100" as="geometry" />
        </mxCell>
        <mxCell id="40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;" parent="1" source="38" target="39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="41" value="&lt;span style=&quot;text-align: left; text-wrap: wrap; background-color: rgb(251, 251, 251);&quot;&gt;幂等返回&lt;/span&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=16;textDirection=ltr;" parent="40" vertex="1" connectable="0">
          <mxGeometry x="-0.05" y="2" relative="1" as="geometry">
            <mxPoint x="-448" y="2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="44" value="否" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=16;" parent="1" source="38" target="45" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1994.9999999999995" y="770" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="38" value="判断订单是否已锁定" style="rhombus;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="1" vertex="1">
          <mxGeometry x="1940" y="605" width="110" height="80" as="geometry" />
        </mxCell>
        <mxCell id="39" value="结束" style="rounded=0;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="1" vertex="1">
          <mxGeometry x="3070" y="930" width="100" height="70" as="geometry" />
        </mxCell>
        <mxCell id="53" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="1" source="45" target="27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="45" value="抛异常：该订单状态已改变" style="rounded=0;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="1" vertex="1">
          <mxGeometry x="1934.9999999999995" y="750" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="57" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="1" source="48" target="50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="48" value="批次类型: 0普通, 1今日, 2临期&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;不为空商品，以今日视角获取批次日期&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="1" vertex="1">
          <mxGeometry x="1569.99" y="770" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="121" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="1" source="50" target="52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="50" value="获取商品可售期/天数" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="1" vertex="1">
          <mxGeometry x="1604.99" y="910" width="150" height="50" as="geometry" />
        </mxCell>
        <mxCell id="154" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="1" source="52" target="146" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="52" value="锁定库存：com.ddmc.inventory.center.app.service.impl.InventoryCenterServiceImpl#doLock" style="swimlane;fontSize=20;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1100" width="2163.89" height="4060" as="geometry" />
        </mxCell>
        <mxCell id="137" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="33" target="83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="33" value="复制操作后的库存数据，并排序" style="rounded=0;whiteSpace=wrap;html=1;fontSize=16;align=left;" parent="52" vertex="1">
          <mxGeometry x="735.35" y="890" width="230.58" height="60" as="geometry" />
        </mxCell>
        <mxCell id="60" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="55" target="58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="61" value="是" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="60" vertex="1" connectable="0">
          <mxGeometry x="-0.0219" y="1" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="55" target="63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="55" value="是否预售订单，预计配送日期大于当前时间&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;预售订单类型或大客户预约单&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="720" y="79" width="261.28" height="120" as="geometry" />
        </mxCell>
        <mxCell id="58" value="预售订单直接写入订单记录表&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;toLock字段：&lt;span style=&quot;background-color: initial;&quot;&gt;订单操作记录：下单直接将请求商品及数量写入待转锁字段&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="1310" y="95" width="260" height="80" as="geometry" />
        </mxCell>
        <mxCell id="65" value="否" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="52" source="63" target="74" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="340" y="460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="70" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="63" target="69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="72" value="是" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="70" vertex="1" connectable="0">
          <mxGeometry x="-0.1374" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="63" value="店铺支持在途库存" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=center;" parent="52" vertex="1">
          <mxGeometry x="775.14" y="280" width="151" height="90" as="geometry" />
        </mxCell>
        <mxCell id="75" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="66" target="74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="66" value="获取操作前在途库存数据：&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. 获取在途站点黑名单&lt;br&gt;&lt;/div&gt;&lt;div&gt;2. transfer_station_config表：可以获取在途最早可预约时间&lt;/div&gt;&lt;div style=&quot;&quot;&gt;3. 查询在途商品配置&amp;nbsp;transfer_product_city_config表&lt;/div&gt;&lt;div style=&quot;&quot;&gt;4.查询在途库存&amp;nbsp;inventory_transfer&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="1189.5" y="456" width="410" height="126" as="geometry" />
        </mxCell>
        <mxCell id="71" value="是" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="69" target="66" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="69" value="（是否降级非今日在途查询&lt;span style=&quot;background-color: initial;&quot;&gt;或 配送日期是明天&lt;/span&gt;） &amp;amp;&amp;amp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;普通订单 &amp;amp;&amp;amp; 订单记录为空&lt;/span&gt;" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="1249.5" y="265" width="290" height="120" as="geometry" />
        </mxCell>
        <mxCell id="111" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="74" target="76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="74" value="操作前库存数据：&lt;span style=&quot;background-color: initial;&quot;&gt;查询源库存数据&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="727.5600000000001" y="487" width="246.16" height="64" as="geometry" />
        </mxCell>
        <mxCell id="87" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="76" target="33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="76" value="是抖音订单" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="791.86" y="690" width="117.56" height="80" as="geometry" />
        </mxCell>
        <mxCell id="139" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="83" target="122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="83" value="           下单时计算库存：遍历所有库存操作，记录操作详情" style="swimlane;fontSize=18;align=left;startSize=30;" parent="52" vertex="1">
          <mxGeometry x="151.92000000000002" y="1130" width="1397.44" height="1670" as="geometry" />
        </mxCell>
        <mxCell id="136" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="83" source="86" target="95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="86" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;根据商品id对操作商品库存信息、效期活动操作商品信息 进行分组&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;根据入参计算 需要锁定的总库存数量 Map&amp;lt;商品ID,Map&amp;lt;今日上架类型,总需要扣减数量&amp;gt;&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;聚合库存操作数量 外层key：商品id 内存key：今日上架类型&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="83" vertex="1">
          <mxGeometry x="390.72" y="100" width="616" height="100" as="geometry" />
        </mxCell>
        <mxCell id="95" value="单商品扣减库存处理" style="swimlane;fontSize=15;align=left;" parent="83" vertex="1">
          <mxGeometry x="182.76000000000002" y="258" width="1031.92" height="1332" as="geometry" />
        </mxCell>
        <mxCell id="115" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="95" source="96" target="101" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="96" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; 统计活动类型及需要扣减的数量：效期类型：临期 或 默认(即不区分库存类型的总库存)&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 入参有：效期商品操作集合&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 根据规则计算效期扣减顺序，优先效期类型=临期&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 遍历活动类型及需要扣减的数量：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 筛选过滤源/在途库存数据：生产日期匹配规则和没有规则的&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 今日上架品：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 源库存，&amp;nbsp; 生产日期 = (T-1)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 在途库存，生产日期 = (配送日期-1)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 非今日上架品：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 源库存，&amp;nbsp; &amp;nbsp;生产日期&amp;lt;(T-1)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 在途库存， 生产日期 = (配送日期-1)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="165.96" y="50" width="700" height="260" as="geometry" />
        </mxCell>
        <mxCell id="119" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="95" source="97" target="100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="97" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;遍历筛选后源库存数据，逐个扣减。&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 计算可扣减库存数，并修改扣减后的结果：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; public static long calculateAndLock(InventoryOriginEntity origin, long count) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long canLockCount;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; canLockCount = NumberUtils.min(count, origin.getCurrentQuantity());&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (canLockCount &amp;lt;= 0) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; origin.setCurrentQuantity(origin.getCurrentQuantity() - canLockCount);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; origin.setLockQuantity(origin.getLockQuantity() + canLockCount);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return canLockCount;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 锁定扣减库存对象，记录被锁定源/调拨库存详情。（Map&amp;lt;Inventory_origin表number，number+商品id+店铺id+扣减数量&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="94.71000000000001" y="810" width="842.5" height="300" as="geometry" />
        </mxCell>
        <mxCell id="116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="95" source="101" target="102" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="101" value="&lt;div&gt;遍历筛选数据，并将商品数量相加获取商品库存总量。&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;库存类型=源库存&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 状态是“售卖中”，累加可售卖总库存currentQuantity&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 状态是“暂停售卖” &amp;amp;&amp;amp; 库存类型=“人工设置”，累加暂停售卖总库存&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;库存类型=调拨库存&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 累加可售卖总库存&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="325.96" y="360" width="380" height="140" as="geometry" />
        </mxCell>
        <mxCell id="117" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="95" source="102" target="107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="102" value="判断源/调拨库存是否足够扣减" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="397.98" y="541" width="235.96" height="87.5" as="geometry" />
        </mxCell>
        <mxCell id="118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="95" source="107" target="97" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="107" value="提前判断总库存是否足够(大于入参商品需扣减量)： 未暂停/售卖中库存 &amp;lt; 需要锁定count &amp;amp;&amp;amp; (普通订单 || 换货订单)" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="125.96000000000001" y="682" width="780" height="60" as="geometry" />
        </mxCell>
        <mxCell id="100" value="&lt;div&gt;库存总量不够扣减：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 普通订单||换货订单：提示库存不足&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 预售订单 || 营销发起库存隔离订单 || 大客户预约单：将缺少部分写入操作记录，并定时重试&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 在途订单：记录缺少的/待锁定库存到调拨库存数据，定时重试&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="95" vertex="1">
          <mxGeometry x="200.96" y="1182" width="629.04" height="88" as="geometry" />
        </mxCell>
        <mxCell id="88" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="84" target="33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="84" value="排序规则：&lt;div&gt;1、判断库存来源：[&lt;span style=&quot;background-color: initial;&quot;&gt;人工设置&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;]优先级高于FDC和算法设置；&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;2、&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;如果优先锁普通库存，临期日期不为空且临期日期不为当天&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;2、生产日期从早到晚&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="275.89" y="865" width="290" height="110" as="geometry" />
        </mxCell>
        <mxCell id="109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="47" target="74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="47" value="&lt;span style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;查询源库存数据条件: 状态、商品、门店id&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;1. 门店id的hash值（store_hash）&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;2. 商品id（数组）（product_id）&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;3. 状态（IN_SALE售卖中、暂停中SUSPEND）（status）&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;4. 有效性（1: 有效）（is_valid）&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;5. 根据id正序排序&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;3&quot; face=&quot;Inter, -apple-system, system-ui, Segoe UI, SF Pro SC, SF Pro Display, SF Pro Icons, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif&quot; color=&quot;#1c1f23&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;6. 获取数据量（Apollo中配置） &lt;/span&gt;&lt;/font&gt;&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="39.99999999999994" y="444" width="410" height="150" as="geometry" />
        </mxCell>
        <mxCell id="110" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="54" target="47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="54" value="store_hash字段计算：&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(StringUtils.isBlank(storeId)) ? 0 : storeId.hashCode() &amp;amp; Integer.MAX_VALUE;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="94.99999999999999" y="300" width="300" height="80" as="geometry" />
        </mxCell>
        <mxCell id="125" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="79" target="33" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1746" y="920" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="79" value="1、操作前库存隔离单据：&lt;span style=&quot;background-color: initial;&quot;&gt;库存隔离单据记录表 inventory_isolation_apply_log&lt;/span&gt;&lt;div&gt;(1) 站点id&lt;/div&gt;&lt;div&gt;(2)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;业务类型biz_type：抖音渠道隔离&lt;/span&gt;&lt;/div&gt;&lt;div&gt;(3)&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;status锁定&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;2、&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;库存隔离锁定处理：&lt;/span&gt;&lt;/div&gt;&lt;div&gt;2.1 有库存隔离单据就处理，按照库存隔离单创建时间排序&lt;/div&gt;&lt;div&gt;2.2 如果商品有在途库存，不扣减隔离库存&lt;/div&gt;&lt;div&gt;2.3 每个需要操作商品处理&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;找出操作商品对应的&amp;nbsp; 原库存唯一编号，今日上架 生产日期=T-1,非今日上架 生产日期&amp;lt;T-1&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;判断库存隔离单据已锁定住的库存lockCount和商品下单扣减数量count。&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; (1) lockCount&amp;gt;count: lockCount = lockCount-count、count变0&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; (2) lockCount=count: lockCount=0、count变0&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; (3) lockCount&amp;lt;count: lockCount=0、count=count-lockCount&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="1445.8899999999999" y="585" width="568" height="290" as="geometry" />
        </mxCell>
        <mxCell id="80" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="76" target="79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="81" value="是" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="80" vertex="1" connectable="0">
          <mxGeometry x="-0.0301" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="152" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="52" source="122" target="126" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="122" value="修改库存数据，记录订单操作记录" style="swimlane;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="159.92999999999998" y="2920" width="1381.42" height="710" as="geometry" />
        </mxCell>
        <mxCell id="149" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="122" source="123" target="147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="123" value="&lt;div&gt;锁定库存：&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;1、锁定源库存：&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;根据唯一number从小到大更新&lt;/span&gt;&lt;/div&gt;&lt;div&gt;2、新增订单操作日志&lt;/div&gt;&lt;div&gt;3、是抖音下单：更新库存隔离单据&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="122" vertex="1">
          <mxGeometry x="101.42" y="150" width="348.58" height="90" as="geometry" />
        </mxCell>
        <mxCell id="128" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="122" source="124" target="127" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="129" value="有" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="128" vertex="1" connectable="0">
          <mxGeometry x="0.3583" y="6" relative="1" as="geometry">
            <mxPoint y="-1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="130" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;fontSize=15;" parent="122" source="124" target="123" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="131" value="没有" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="130" vertex="1" connectable="0">
          <mxGeometry x="-0.3536" y="-6" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="124" value="有订单操作记录" style="rhombus;whiteSpace=wrap;html=1;fontSize=15;align=center;" parent="122" vertex="1">
          <mxGeometry x="561.42" y="50" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="150" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="122" source="127" target="147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="127" value="&lt;div&gt;&lt;div&gt;重试锁定库存：&lt;/div&gt;&lt;div&gt;1、源库存操作&lt;/div&gt;&lt;div style=&quot;&quot;&gt;2、更新订单操作日志&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="122" vertex="1">
          <mxGeometry x="841.42" y="170" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="147" value="&lt;div&gt;更新条件：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 库存唯一编号（number）&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 门店id的hash值（store_hash）&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 当前数量大于改变的当前库存数量&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 有效性（1：有效）（is_valid）&lt;/div&gt;&lt;div&gt;更新的内容：&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 当前的数量：当前表中当前数量 - 改变的当前库存数量&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; 锁定的数量：当前表中锁定的数量 + 改变的锁定库存数量&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="122" vertex="1">
          <mxGeometry x="360.07" y="370" width="409.93" height="190" as="geometry" />
        </mxCell>
        <mxCell id="151" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="122" source="148" target="147" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="148" value="&lt;div&gt;UPDATE inventory_origin s&lt;/div&gt;&lt;div&gt;SET&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; s.current_quantity = s.current_quantity + #{changeCurrentQuantity},&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; s.lock_quantity = s.lock_quantity + #{changeLockQuantity}&lt;/div&gt;&lt;div&gt;WHERE&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; s.number = #{number}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AND s.status = #{status}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AND s.store_hash = #{storeHash}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AND s.current_quantity &amp;gt;= #{currentQuantity}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; AND s.is_valid = 1;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="122" vertex="1">
          <mxGeometry x="930.07" y="365" width="420" height="200" as="geometry" />
        </mxCell>
        <mxCell id="153" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=15;" parent="52" source="126" target="145" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="126" value="抖音订单：发送库存隔离变更消息" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=center;" parent="52" vertex="1">
          <mxGeometry x="719.42" y="3720" width="262.44" height="60" as="geometry" />
        </mxCell>
        <mxCell id="145" value="如果操作前和操作后的集合都为空，则不发送库存变更消息" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="52" vertex="1">
          <mxGeometry x="650.64" y="3870" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="62" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=15;" parent="1" source="58" target="39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="103" value="抛异常" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="1" vertex="1">
          <mxGeometry x="2710" y="2730" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="104" style="edgeStyle=orthogonalEdgeStyle;rounded=0;jumpStyle=arc;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=15;" parent="1" source="102" target="103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="105" value="否" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=15;" parent="104" vertex="1" connectable="0">
          <mxGeometry x="-0.4877" y="-6" relative="1" as="geometry">
            <mxPoint x="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="146" value="分布式锁解锁：对订单id和商品id集合" style="rounded=0;whiteSpace=wrap;html=1;fontSize=15;align=left;" parent="1" vertex="1">
          <mxGeometry x="1704.62" y="5340" width="274.65" height="50" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
